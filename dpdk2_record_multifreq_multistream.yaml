##########################################
#
# dpdk2_record_multifreq_multistream.yaml
#
# A config which allows for the recording of 32 streams of data, each with 8 freqs
#
# Author: Calvin Leung
##########################################
---
type: config
# Logging level can be one of:
# OFF, ERROR, WARN, INFO, DEBUG, DEBUG2 (case insensitive)
# Note DEBUG and DEBUG2 require a build with (-DCMAKE_BUILD_TYPE=Debug)
log_level: DEBUG

baseband_buffer_depth: 40 # # keep at least N-5 frames in buffer before overwriting old data

samples_per_data_set: 65536 # keep at 65536
num_elements: 256 #correlator inputs; change back to 2048
num_local_freq: 8
base_dir: /home/masuilab/tmp
# block_size: 2

# OPTION 1: all 32 streams, 1 stream/lcore
# cpu_affinity: [4,5,6,7,16,17,18,19] #[4,5,6,7]
cpu_affinity: [8,9,10,11,20,21,22,23,32,33,34,35,44,45,46,47]
# OPTION 2: first8 streams, 1 stream/lcore
# cpu_affinity: [0,1,2,3]
# OPTION 3: last 8 streams, 1 stream/lcore
# cpu_affinity: [4,5,6,7]
# OPTION 4: 2 streams/lcore
# cpu_affinity: [4, 5, 6, 7, 8, 9, 10, 11, 16, 17, 18, 19, 20,21,22,23] #[4,5,6,7]
#num_disks: 10
instrument_name: lab_test

# Pool
main_pool:
    kotekan_metadata_pool: chimeMetadata
    num_metadata_objects: 33*baseband_buffer_depth

# Buffers
gpu_input_buffers:
    num_frames: baseband_buffer_depth
    frame_size: samples_per_data_set * num_elements * num_local_freq
    metadata_pool: main_pool
    gpu_input_buffer_0:
        kotekan_buffer: standard
        numa_node: 0
    gpu_input_buffer_1:
        kotekan_buffer: standard
        numa_node: 0
    gpu_input_buffer_2:
        kotekan_buffer: standard
        numa_node: 0
    gpu_input_buffer_3:
        kotekan_buffer: standard
        numa_node: 0
    gpu_input_buffer_4:
        kotekan_buffer: standard
        numa_node: 0
    gpu_input_buffer_5:
        kotekan_buffer: standard
        numa_node: 0
    gpu_input_buffer_6:
        kotekan_buffer: standard
        numa_node: 0
    gpu_input_buffer_7:
        kotekan_buffer: standard
        numa_node: 0
    gpu_input_buffer_8:
        kotekan_buffer: standard
        numa_node: 0
    gpu_input_buffer_9:
        kotekan_buffer: standard
        numa_node: 0
    gpu_input_buffer_10:
        kotekan_buffer: standard
        numa_node: 0
    gpu_input_buffer_11:
        kotekan_buffer: standard
        numa_node: 0
    gpu_input_buffer_12:
        kotekan_buffer: standard
        numa_node: 0
    gpu_input_buffer_13:
        kotekan_buffer: standard
        numa_node: 0
    gpu_input_buffer_14:
        kotekan_buffer: standard
        numa_node: 0
    gpu_input_buffer_15:
        kotekan_buffer: standard
        numa_node: 0
    gpu_input_buffer_16:
        kotekan_buffer: standard
        numa_node: 1
    gpu_input_buffer_17:
        kotekan_buffer: standard
        numa_node: 1
    gpu_input_buffer_18:
        kotekan_buffer: standard
        numa_node: 1
    gpu_input_buffer_19:
        kotekan_buffer: standard
        numa_node: 1
    gpu_input_buffer_20:
        kotekan_buffer: standard
        numa_node: 1
    gpu_input_buffer_21:
        kotekan_buffer: standard
        numa_node: 1
    gpu_input_buffer_22:
        kotekan_buffer: standard
        numa_node: 1
    gpu_input_buffer_23:
        kotekan_buffer: standard
        numa_node: 1
    gpu_input_buffer_24:
        kotekan_buffer: standard
        numa_node: 1
    gpu_input_buffer_25:
        kotekan_buffer: standard
        numa_node: 1
    gpu_input_buffer_26:
        kotekan_buffer: standard
        numa_node: 1
    gpu_input_buffer_27:
        kotekan_buffer: standard
        numa_node: 1
    gpu_input_buffer_28:
        kotekan_buffer: standard
        numa_node: 1
    gpu_input_buffer_29:
        kotekan_buffer: standard
        numa_node: 1
    gpu_input_buffer_30:
        kotekan_buffer: standard
        numa_node: 1
    gpu_input_buffer_31:
        kotekan_buffer: standard
        numa_node: 1

lost_samples_buffers:
    num_frames: baseband_buffer_depth
    frame_size: samples_per_data_set
    metadata_pool: main_pool
    lost_samples_buffer_0:
        kotekan_buffer: standard
        numa_node: 0
    lost_samples_buffer_1:
        kotekan_buffer: standard
        numa_node: 0
    lost_samples_buffer_2:
        kotekan_buffer: standard
        numa_node: 0
    lost_samples_buffer_3:
        kotekan_buffer: standard
        numa_node: 0
    lost_samples_buffer_4:
        kotekan_buffer: standard
        numa_node: 0
    lost_samples_buffer_5:
        kotekan_buffer: standard
        numa_node: 0
    lost_samples_buffer_6:
        kotekan_buffer: standard
        numa_node: 0
    lost_samples_buffer_7:
        kotekan_buffer: standard
        numa_node: 0
    lost_samples_buffer_8:
        kotekan_buffer: standard
        numa_node: 0
    lost_samples_buffer_9:
        kotekan_buffer: standard
        numa_node: 0
    lost_samples_buffer_10:
        kotekan_buffer: standard
        numa_node: 0
    lost_samples_buffer_11:
        kotekan_buffer: standard
        numa_node: 0
    lost_samples_buffer_12:
        kotekan_buffer: standard
        numa_node: 0
    lost_samples_buffer_13:
        kotekan_buffer: standard
        numa_node: 0
    lost_samples_buffer_14:
        kotekan_buffer: standard
        numa_node: 0
    lost_samples_buffer_15:
        kotekan_buffer: standard
        numa_node: 0
    lost_samples_buffer_16:
        kotekan_buffer: standard
        numa_node: 1
    lost_samples_buffer_17:
        kotekan_buffer: standard
        numa_node: 1
    lost_samples_buffer_18:
        kotekan_buffer: standard
        numa_node: 1
    lost_samples_buffer_19:
        kotekan_buffer: standard
        numa_node: 1
    lost_samples_buffer_20:
        kotekan_buffer: standard
        numa_node: 1
    lost_samples_buffer_21:
        kotekan_buffer: standard
        numa_node: 1
    lost_samples_buffer_22:
        kotekan_buffer: standard
        numa_node: 1
    lost_samples_buffer_23:
        kotekan_buffer: standard
        numa_node: 1
    lost_samples_buffer_24:
        kotekan_buffer: standard
        numa_node: 1
    lost_samples_buffer_25:
        kotekan_buffer: standard
        numa_node: 1
    lost_samples_buffer_26:
        kotekan_buffer: standard
        numa_node: 1
    lost_samples_buffer_27:
        kotekan_buffer: standard
        numa_node: 1
    lost_samples_buffer_28:
        kotekan_buffer: standard
        numa_node: 1
    lost_samples_buffer_29:
        kotekan_buffer: standard
        numa_node: 1
    lost_samples_buffer_30:
        kotekan_buffer: standard
        numa_node: 1
    lost_samples_buffer_31:
        kotekan_buffer: standard
        numa_node: 1



# Stages

# The core mapping here is setup for a 6 core CPU with 12 threads (vcores)
# and setup to use the first 4 real cores (8 vcores)

dpdk:
    kotekan_stage: dpdkCore
    num_mem_channels: 8
    samples_per_packet: 2
    fpga_packet_size: 4680 #2376 * samples_per_packet
    alignment: samples_per_data_set * num_local_freq 
    mbuf_cache_size: 250
    master_lcore_cpu: 23
    # Format is index = lcore, value = cpu core
    # SEVERAL OPTIONS FOR LCORE_CPU_MAP
    # OPTION 1: 1 stream/lcore, 32 streams
    # lcore_cpu_map: [0,12,1,13,2,14,3,15,4,16,5,17,6,18,7,19,24] 
    lcore_cpu_map: [0,24,1,25,2,26,3,27,4,28,5,29,6,30,7,31,12,36,13,37,14,38,15,39,16,40,17,41,18,42,19,43]
    # lcore_cpu_map: [24,36,25,37,26,38,27,39,28,40,29,41,30,42,31,43]
    # OPTION 4: 2 streams/lcore
    # lcore_cpu_map: [0,8,1,9,2,10,3,11] #[0,12,1,13,2,14,3,15]
    # lcore_cpu_map: [0,1,2,3,4,5,6,7] #[0,12,1,13,2,14,3,15]
    # lcore_cpu_map: [0,12,1,13,2,14,3,15,4,16,5,17,6,18,7,19]
    # lcore_cpu_map: [0,12,1,13,2,14,3,15] #,4,16,5,17,6,18,7,19]
    # Format is index = lcore, value = array of port IDs
    # so [[0,1],[2,3]] maps lcore 0 to service ports 0 and 1,
    # and lcore 1 to service ports 2 and 3.
    # # OPTION 1: 
    lcore_port_map: # 1 stream/lcore, 16 streams
        - [0]
        - [1]
        - [2]
        - [3]
        - [4]
        - [5]
        - [6]
        - [7]
        - [8]
        - [9]
        - [10]
        - [11]
        - [12]
        - [13]
        - [14]
        - [15]
        - [16]
        - [17]
        - [18]
        - [19]
        - [20]
        - [21]
        - [22]
        - [23]
        - [24]
        - [25]
        - [26]
        - [27]
        - [28]
        - [29]
        - [30]
        - [31]
    # OPTION 2: 1 stream/lcore, first 8 streams
    # lcore_port_map: #1 stream/lcore, first 8 streams
    #     - [0]
    #     - [1]
    #     - [2]
    #     - [3]
    #     - [4]
    #     - [5]
    #     - [6]
    #     - [7]
    #     - [8,9,10,11,12,13,14,15]
    # lcore_port_map: # 1 stream/lcore,last 8 streams
    #     - [0,1,2,3,4,5,6,7]
    #     - [8]
    #     - [9]
    #     - [10]
    #     - [11]
    #     - [12]
    #     - [13]
    #     - [14]
    #     - [15]
    # lcore_port_map: # 2 streams/lcore, all 16
    #     - [0,1]
    #     - [2,3]
    #     - [4,5]
    #     - [6,7]
    #     - [8,9]
    #     - [10,11]
    #     - [12,13]
    #     - [14,15]
    # One handler must be given per port on the system.
    # 0-7th: Second ICEBoard, 8-15th: First ICEBoard.
    handlers:
        #         - dpdk_handler: none
        #         - dpdk_handler: none
        #         - dpdk_handler: none
        #         - dpdk_handler: none
        #         - dpdk_handler: none
        #         - dpdk_handler: none
        #         - dpdk_handler: none
        #         - dpdk_handler: none
        #         - dpdk_handler: none
        #         - dpdk_handler: none
        #         - dpdk_handler: none
        #         - dpdk_handler: none
        #         - dpdk_handler: none
        #         - dpdk_handler: none
        #         - dpdk_handler: none
        #         - dpdk_handler: none
        - dpdk_handler: iceBoardStandard
          out_buf: gpu_input_buffer_0
          lost_samples_buf: lost_samples_buffer_0
        - dpdk_handler: iceBoardStandard
          out_buf: gpu_input_buffer_1
          lost_samples_buf: lost_samples_buffer_1
        - dpdk_handler: iceBoardStandard
          out_buf: gpu_input_buffer_2
          lost_samples_buf: lost_samples_buffer_2
        - dpdk_handler: iceBoardStandard
          out_buf: gpu_input_buffer_3
          lost_samples_buf: lost_samples_buffer_3
        - dpdk_handler: iceBoardStandard
          out_buf: gpu_input_buffer_4
          lost_samples_buf: lost_samples_buffer_4
        - dpdk_handler: iceBoardStandard
          out_buf: gpu_input_buffer_5
          lost_samples_buf: lost_samples_buffer_5
        - dpdk_handler: iceBoardStandard
          out_buf: gpu_input_buffer_6
          lost_samples_buf: lost_samples_buffer_6
        - dpdk_handler: iceBoardStandard
          out_buf: gpu_input_buffer_7
          lost_samples_buf: lost_samples_buffer_7
        - dpdk_handler: iceBoardStandard
          out_buf: gpu_input_buffer_8
          lost_samples_buf: lost_samples_buffer_8
        - dpdk_handler: iceBoardStandard
          out_buf: gpu_input_buffer_9
          lost_samples_buf: lost_samples_buffer_9
        - dpdk_handler: iceBoardStandard
          out_buf: gpu_input_buffer_10
          lost_samples_buf: lost_samples_buffer_10
        - dpdk_handler: iceBoardStandard
          out_buf: gpu_input_buffer_11
          lost_samples_buf: lost_samples_buffer_11
        - dpdk_handler: iceBoardStandard
          out_buf: gpu_input_buffer_12
          lost_samples_buf: lost_samples_buffer_12
        - dpdk_handler: iceBoardStandard 
          out_buf: gpu_input_buffer_13
          lost_samples_buf: lost_samples_buffer_13
        - dpdk_handler: iceBoardStandard
          out_buf: gpu_input_buffer_14
          lost_samples_buf: lost_samples_buffer_14
        - dpdk_handler: iceBoardStandard
          out_buf: gpu_input_buffer_15
          lost_samples_buf: lost_samples_buffer_15
        - dpdk_handler: iceBoardStandard
          out_buf: gpu_input_buffer_16
          lost_samples_buf: lost_samples_buffer_16
        - dpdk_handler: iceBoardStandard
          out_buf: gpu_input_buffer_17
          lost_samples_buf: lost_samples_buffer_17
        - dpdk_handler: iceBoardStandard
          out_buf: gpu_input_buffer_18
          lost_samples_buf: lost_samples_buffer_18
        - dpdk_handler: iceBoardStandard
          out_buf: gpu_input_buffer_19
          lost_samples_buf: lost_samples_buffer_19
        - dpdk_handler: iceBoardStandard
          out_buf: gpu_input_buffer_20
          lost_samples_buf: lost_samples_buffer_20
        - dpdk_handler: iceBoardStandard
          out_buf: gpu_input_buffer_21
          lost_samples_buf: lost_samples_buffer_21
        - dpdk_handler: iceBoardStandard
          out_buf: gpu_input_buffer_22
          lost_samples_buf: lost_samples_buffer_22
        - dpdk_handler: iceBoardStandard
          out_buf: gpu_input_buffer_23
          lost_samples_buf: lost_samples_buffer_23
        - dpdk_handler: iceBoardStandard
          out_buf: gpu_input_buffer_24
          lost_samples_buf: lost_samples_buffer_24
        - dpdk_handler: iceBoardStandard
          out_buf: gpu_input_buffer_25
          lost_samples_buf: lost_samples_buffer_25
        - dpdk_handler: iceBoardStandard
          out_buf: gpu_input_buffer_26
          lost_samples_buf: lost_samples_buffer_26
        - dpdk_handler: iceBoardStandard
          out_buf: gpu_input_buffer_27
          lost_samples_buf: lost_samples_buffer_27
        - dpdk_handler: iceBoardStandard
          out_buf: gpu_input_buffer_28
          lost_samples_buf: lost_samples_buffer_28
        - dpdk_handler: iceBoardStandard
          out_buf: gpu_input_buffer_29
          lost_samples_buf: lost_samples_buffer_29
        - dpdk_handler: iceBoardStandard
          out_buf: gpu_input_buffer_30
          lost_samples_buf: lost_samples_buffer_30
        - dpdk_handler: iceBoardStandard
          out_buf: gpu_input_buffer_31
          lost_samples_buf: lost_samples_buffer_31

# Note this is needed when using the dpdk handler above
zero_samples:
    zero_samples_0:
        kotekan_stage: zeroSamples
        out_buf: gpu_input_buffer_0
        lost_samples_buf: lost_samples_buffer_0
    zero_samples_1:
        kotekan_stage: zeroSamples
        out_buf: gpu_input_buffer_1
        lost_samples_buf: lost_samples_buffer_1
    zero_samples_2:
        kotekan_stage: zeroSamples
        out_buf: gpu_input_buffer_2
        lost_samples_buf: lost_samples_buffer_2
    zero_samples_3:
        kotekan_stage: zeroSamples
        out_buf: gpu_input_buffer_3
        lost_samples_buf: lost_samples_buffer_3
    zero_samples_4:
        kotekan_stage: zeroSamples
        out_buf: gpu_input_buffer_4
        lost_samples_buf: lost_samples_buffer_4
    zero_samples_5:
        kotekan_stage: zeroSamples
        out_buf: gpu_input_buffer_5
        lost_samples_buf: lost_samples_buffer_5
    zero_samples_6:
        kotekan_stage: zeroSamples
        out_buf: gpu_input_buffer_6
        lost_samples_buf: lost_samples_buffer_6
    zero_samples_7:
        kotekan_stage: zeroSamples
        out_buf: gpu_input_buffer_7
        lost_samples_buf: lost_samples_buffer_7
    zero_samples_8:
        kotekan_stage: zeroSamples
        out_buf: gpu_input_buffer_8
        lost_samples_buf: lost_samples_buffer_8
    zero_samples_9:
        kotekan_stage: zeroSamples
        out_buf: gpu_input_buffer_9
        lost_samples_buf: lost_samples_buffer_9
    zero_samples_10:
        kotekan_stage: zeroSamples
        out_buf: gpu_input_buffer_10
        lost_samples_buf: lost_samples_buffer_10
    zero_samples_11:
        kotekan_stage: zeroSamples
        out_buf: gpu_input_buffer_11
        lost_samples_buf: lost_samples_buffer_11
    zero_samples_12:
        kotekan_stage: zeroSamples
        out_buf: gpu_input_buffer_12
        lost_samples_buf: lost_samples_buffer_12
    zero_samples_13:
        kotekan_stage: zeroSamples
        out_buf: gpu_input_buffer_13
        lost_samples_buf: lost_samples_buffer_13
    zero_samples_14:
        kotekan_stage: zeroSamples
        out_buf: gpu_input_buffer_14
        lost_samples_buf: lost_samples_buffer_14
    zero_samples_15:
        kotekan_stage: zeroSamples
        out_buf: gpu_input_buffer_15
        lost_samples_buf: lost_samples_buffer_15
    zero_16:
        kotekan_stage: zeroSamples
        out_buf: gpu_input_buffer_16
        lost_samples_buf: lost_samples_buffer_16
    zero_17:
        kotekan_stage: zeroSamples
        out_buf: gpu_input_buffer_17
        lost_samples_buf: lost_samples_buffer_17
    zero_18:
        kotekan_stage: zeroSamples
        out_buf: gpu_input_buffer_18
        lost_samples_buf: lost_samples_buffer_18
    zero_19:
        kotekan_stage: zeroSamples
        out_buf: gpu_input_buffer_19
        lost_samples_buf: lost_samples_buffer_19
    zero_20:
        kotekan_stage: zeroSamples
        out_buf: gpu_input_buffer_20
        lost_samples_buf: lost_samples_buffer_20
    zero_21:
        kotekan_stage: zeroSamples
        out_buf: gpu_input_buffer_21
        lost_samples_buf: lost_samples_buffer_21
    zero_22:
        kotekan_stage: zeroSamples
        out_buf: gpu_input_buffer_22
        lost_samples_buf: lost_samples_buffer_22
    zero_23:
        kotekan_stage: zeroSamples
        out_buf: gpu_input_buffer_23
        lost_samples_buf: lost_samples_buffer_23
    zero_24:
        kotekan_stage: zeroSamples
        out_buf: gpu_input_buffer_24
        lost_samples_buf: lost_samples_buffer_24
    zero_25:
        kotekan_stage: zeroSamples
        out_buf: gpu_input_buffer_25
        lost_samples_buf: lost_samples_buffer_25
    zero_26:
        kotekan_stage: zeroSamples
        out_buf: gpu_input_buffer_26
        lost_samples_buf: lost_samples_buffer_26
    zero_27:
        kotekan_stage: zeroSamples
        out_buf: gpu_input_buffer_27
        lost_samples_buf: lost_samples_buffer_27
    zero_28:
        kotekan_stage: zeroSamples
        out_buf: gpu_input_buffer_28
        lost_samples_buf: lost_samples_buffer_28
    zero_29:
        kotekan_stage: zeroSamples
        out_buf: gpu_input_buffer_29
        lost_samples_buf: lost_samples_buffer_29
    zero_30:
        kotekan_stage: zeroSamples
        out_buf: gpu_input_buffer_30
        lost_samples_buf: lost_samples_buffer_30
    zero_31:
        kotekan_stage: zeroSamples
        out_buf: gpu_input_buffer_31
        lost_samples_buf: lost_samples_buffer_31

baseband:
    max_dump_samples: 400000
    num_frames_buffer: baseband_buffer_depth - 4
    base_dir: /home/masuilab/cpu-record-config/
    write_throttle: 0
    baseband_0:
        kotekan_stage: basebandReadout
        in_buf: gpu_input_buffer_0
    baseband_1:
        kotekan_stage: basebandReadout
        in_buf: gpu_input_buffer_1
    baseband_2:
        kotekan_stage: basebandReadout
        in_buf: gpu_input_buffer_2
    baseband_3:
        kotekan_stage: basebandReadout
        in_buf: gpu_input_buffer_3
    baseband_4:
        kotekan_stage: basebandReadout
        in_buf: gpu_input_buffer_4
    baseband_5:
        kotekan_stage: basebandReadout
        in_buf: gpu_input_buffer_5
    baseband_6: 
        kotekan_stage: basebandReadout
        in_buf: gpu_input_buffer_6
    baseband_7:
        kotekan_stage: basebandReadout
        in_buf: gpu_input_buffer_7
        #    baseband_8:
        #        kotekan_stage: basebandReadout
        #        in_buf: gpu_input_buffer_8
        #    baseband_9:
        #        kotekan_stage: basebandReadout
        #        in_buf: gpu_input_buffer_9
        #    baseband_10:
        #        kotekan_stage: basebandReadout
        #        in_buf: gpu_input_buffer_10
        #    baseband_11:
        #        kotekan_stage: basebandReadout
        #        in_buf: gpu_input_buffer_11
        #    baseband_12:
        #        kotekan_stage: basebandReadout
        #        in_buf: gpu_input_buffer_12
        #    baseband_13:
        #        kotekan_stage: basebandReadout
        #        in_buf: gpu_input_buffer_13
        #    baseband_14:
        #        kotekan_stage: basebandReadout
        #        in_buf: gpu_input_buffer_14
        #    baseband_15:
        #        kotekan_stage: basebandReadout
        #        in_buf: gpu_input_buffer_15
    baseband_16:
        kotekan_stage: basebandReadout
        in_buf: gpu_input_buffer_16
    baseband_17:
        kotekan_stage: basebandReadout
        in_buf: gpu_input_buffer_17
    baseband_18:
        kotekan_stage: basebandReadout
        in_buf: gpu_input_buffer_18
    baseband_19:
        kotekan_stage: basebandReadout
        in_buf: gpu_input_buffer_19
    baseband_20:
        kotekan_stage: basebandReadout
        in_buf: gpu_input_buffer_20
    baseband_21:
        kotekan_stage: basebandReadout
        in_buf: gpu_input_buffer_21
    baseband_22:
        kotekan_stage: basebandReadout
        in_buf: gpu_input_buffer_22
    baseband_23:
        kotekan_stage: basebandReadout
        in_buf: gpu_input_buffer_23
        #    baseband_24:
        #        kotekan_stage: basebandReadout
        #        in_buf: gpu_input_buffer_24
        #    baseband_25:
        #        kotekan_stage: basebandReadout
        #        in_buf: gpu_input_buffer_25
        #    baseband_26:
        #        kotekan_stage: basebandReadout
        #        in_buf: gpu_input_buffer_26
        #    baseband_27:
        #        kotekan_stage: basebandReadout
        #        in_buf: gpu_input_buffer_27
        #    baseband_28:
        #        kotekan_stage: basebandReadout
        #        in_buf: gpu_input_buffer_28
        #    baseband_29:
        #        kotekan_stage: basebandReadout
        #        in_buf: gpu_input_buffer_29
        #    baseband_30:
        #        kotekan_stage: basebandReadout
        #        in_buf: gpu_input_buffer_30
        #    baseband_31:
        #        kotekan_stage: basebandReadout
        #        in_buf: gpu_input_buffer_31

        # hex_dump:
        #     kotekan_stage: hexDump
        #     buf: gpu_input_buffer_0

